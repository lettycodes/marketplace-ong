generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  email       String    @unique @db.VarChar(255)
  description String?   @db.Text
  website     String?   @db.VarChar(255)
  phone       String?   @db.VarChar(50)
  address     String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  users    User[]
  products Product[]
  orders   Order[]

  @@map("organizations")
}

model User {
  id             String  @id @default(uuid())
  email          String  @unique @db.VarChar(255)
  name           String  @db.VarChar(255)
  passwordHash   String  @map("password_hash") @db.VarChar(255)
  organizationId String? @map("organization_id")
  isAdmin        Boolean @default(false) @map("is_admin")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization? @relation(fields: [organizationId], references: [id])
  orders       Order[]

  @@map("users")
}

model Category {
  id       String    @id @default(uuid())
  name     String    @unique @db.VarChar(100)
  products Product[]

  @@map("categories")
}

model Product {
  id             String   @id @default(uuid())
  name           String   @db.VarChar(255)
  description    String   @db.Text
  price          Decimal  @db.Decimal(10, 2)
  imageUrl       String?  @map("image_url") @db.VarChar(500)
  stockQty       Int      @map("stock_qty")
  weightGrams    Int      @map("weight_grams")
  organizationId String   @map("organization_id")
  categoryId     String   @map("category_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     Category     @relation(fields: [categoryId], references: [id])
  orderItems   OrderItem[]

  @@map("products")
}

model Order {
  id             String      @id @default(uuid())
  userId         String?     @map("user_id")
  organizationId String      @map("organization_id")
  customerName   String      @map("customer_name") @db.VarChar(255)
  customerEmail  String      @map("customer_email") @db.VarChar(255)
  customerPhone  String?     @map("customer_phone") @db.VarChar(50)
  totalAmount    Decimal     @map("total_amount") @db.Decimal(10, 2)
  status         OrderStatus @default(PENDING)
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user         User?         @relation(fields: [userId], references: [id])
  organization Organization  @relation(fields: [organizationId], references: [id])
  orderItems   OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Log {
  id             String    @id @default(uuid())
  timestamp      DateTime  @default(now())
  method         String    @db.VarChar(10)
  route          String    @db.VarChar(255)
  statusCode     Int       @map("status_code")
  latencyMs      Int       @map("latency_ms")
  userId         String?   @map("user_id")
  organizationId String?   @map("organization_id")
  userAgent      String?   @map("user_agent") @db.Text
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  
  searchQuery    String?   @map("search_query") @db.Text
  aiFilters      Json?     @map("ai_filters")
  aiSuccess      Boolean?  @map("ai_success")
  fallbackApplied Boolean? @map("fallback_applied")
  
  @@map("logs")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}